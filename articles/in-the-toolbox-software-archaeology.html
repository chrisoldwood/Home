<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:st1="urn:schemas-microsoft-com:office:smarttags"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List
href="in-the-toolbox–software-archaeology_files/filelist.xml">
<title>In The Toolbox – Software Archaeology</title>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="stockticker"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="place"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="PlaceType"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="PlaceName"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="PersonName"/>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Chris Oldwood</o:Author>
  <o:LastAuthor>Chris Oldwood</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>1018</o:TotalTime>
  <o:Created>2014-02-20T22:20:00Z</o:Created>
  <o:LastSaved>2014-02-20T22:20:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>1646</o:Words>
  <o:Characters>9384</o:Characters>
  <o:Company>Co Productions Ltd</o:Company>
  <o:Lines>78</o:Lines>
  <o:Paragraphs>22</o:Paragraphs>
  <o:CharactersWithSpaces>11008</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:GrammarState>Clean</w:GrammarState>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:UseWord2002TableStyleRules/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]--><!--[if !mso]><object
 classid="clsid:38481807-CA0E-42D2-BF39-B33AF135CC4D" id=ieooui></object>
<style>
st1\:*{behavior:url(#ieooui) }
</style>
<![endif]-->
<style>
<!--
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:EN-GB;}
h1
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:16.0pt;
	font-family:Arial;
	mso-font-kerning:16.0pt;
	mso-ansi-language:EN-GB;}
h3
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:3;
	font-size:13.0pt;
	font-family:Arial;
	mso-ansi-language:EN-GB;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
code
	{font-family:"Courier New";
	mso-ascii-font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Courier New";}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
@page Section1
	{size:612.0pt 792.0pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:35.4pt;
	mso-footer-margin:35.4pt;
	mso-paper-source:0;}
div.Section1
	{page:Section1;
	width: 600px;
	margin-left: auto;
	margin-right: auto;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]-->
</head>

<body lang=EN-US link=blue vlink=purple style='tab-interval:36.0pt'>

<div class=Section1>

<h1 align=center style='text-align:center'><span lang=EN-GB>In The Toolbox –
Software Archaeology</span></h1>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal align=right style='text-align:right'><i style='mso-bidi-font-style:
normal'><span lang=EN-GB>“Don’t ever take a fence down until you know why it
was put up” – Robert Frost<o:p></o:p></span></i></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Changing software is hard. It’s especially
hard when you’re new to the team or codebase and don’t know the history of the
people or the application. Making any change is not just as simple as adding,
replacing or removing lines of code. There are also the higher-order aspects to
consider, such as whether it fits in stylistically, idiomatically and within
the existing design principles. In a really old codebase these can be particularly
hard to pin down as they will have undoubtedly changed over time. For example,
new code written today under C++ 11 is going to be quite different to code
written years ago under C++ 98 and that will need to be factored in when trying
to understand what’s going on.</span></p>

<h3><span lang=EN-GB>Small-Scale Archaeology</span></h3>

<p class=MsoNormal><span lang=EN-GB>Putting to one side the stylistic and
idiomatic aspects which may well <span class=GramE>be</span> at the whim of the
author, the design can be a lot harder to understand. Many years ago I worked
on an old C++ codebase for a big finance institution. My role was purely
technical and I was initially tasked with fixing various memory leaks and
deadlocks within its highly threaded services. Whilst tracking down one leak I
came across some code that looked something like this:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>ContextPtr <span
class=GramE>getContext(</span>long contextId)<br>
{<br>
<span style='mso-spacerun:yes'>    </span>static ContextPtr cachedContext;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span><span class=GramE>if</span>
(cachedContext.get() &amp;&amp; cachedContext-&gt;Id() == contextId)<br>
<span style='mso-spacerun:yes'>        </span>return cachedContext;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span><span class=GramE>cachedContext</span> =
Context::Load(contextId);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span><span class=GramE><i style='mso-bidi-font-style:
normal'>new</i></span><i style='mso-bidi-font-style:normal'> ContextPtr(cachedContext);<o:p></o:p></i></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span><span class=GramE>return</span>
cachedContext;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The spurious extra copy of the
smart-pointer was downright weird. I could assume that it was just a cut-and-paste
error or dead code, but it seemed too random for that, especially in such a
short function. So I decided to consult the version control system to see what it
could tell me about its past life.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>This function appeared to have a somewhat chequered
history. Although it had now been stable for a couple of years its birth was a
little more tortuous. The author had originally started without the spurious
smart-pointer copy. They then started adding random try/catch blocks in
different places, presumably because the code was crashing under mysterious
circumstances. Finally the try/catch blocks were gone and there appeared to be
a couple of attempts to mess with the smart-pointer value and reference count
before settling on the final implementation. But what was going on?</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The missing piece of the puzzle is what the
object being pointed to <span class=GramE>contained</span> – a COM object, and
a remote one at that. Putting this knowledge together with the static local
variable, which we know will be destroyed after </span><span class=GramE><code><span
lang=EN-GB style='font-size:10.0pt'>main(</span></code></span><code><span
lang=EN-GB style='font-size:10.0pt'>)</span></code><span lang=EN-GB> exits, and
it all starts to make sense. The author was having lifetime issues because COM
was uninitialised before the C++ based context object was destroyed. This
caused the <st1:stockticker w:st="on">DCOM</st1:stockticker> remote proxy to
throw an exception during invocation of the destructor during process shutdown.
This explains why the try/catch blocks were presumably having no effect – they
were notionally in the wrong place.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Ultimately what the author really needed
was a weak-pointer. The full-blown smart-pointer based single item cache was
keeping the object alive far longer than necessary. The cached reference was a
useful optimisation but the lifetime was deterministically controlled
elsewhere. Once I’d worked all this out I switched from the home-brew
smart-pointer type to one in Boost and the original problem (the memory leak –
a huge one) was fixed.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>All this was “derived” from the version
control history and the author hadn’t written any check-in comments either
which might have saved me time. But there was also some other interesting
metadata about the check-ins that I found interesting too – each commit
appeared to be followed by a formal build (the file with the build number
changed) and was hours apart. This suggested to me that the changes were never
tested locally first. After all, why bother to check-in the intermediate steps
if they didn’t work? This was years before Git was fashionable and there were
no automated tests in sight. It appears as if the changes were tested by
deploying into the shared development environment and waiting to see what
happened.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>When I came to test my own changes I
discovered just how hard it was to test the component in isolation. In
particular the large, monolithic service that formed the heart of the system
was not amenable to localised testing at all without some serious refactoring. I
concluded that whilst the developer was clearly keen to try and resolve the
issue the environment and development process did not seem to be supporting him
in making that happen easily.</span></p>

<h3><span lang=EN-GB>Tribal Knowledge</span></h3>

<p class=MsoNormal><span lang=EN-GB>Sometimes we’re lucky and the person who
wrote the code is still around so we can try and shortcut some of the digging
around. If they’re still working on the project you have the opportunity to
transfer some of the more implicit design knowledge that seeps away over time. More
recently I came across a change to a very simple C# extension method I had
written for the String class. This was my original version:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><code><span lang=EN-GB style='font-size:
10.0pt'>public</span></code></span><code><span lang=EN-GB style='font-size:
10.0pt'> static bool IsEmpty(this string value)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span><span class=GramE>return</span>
(value.Length() == 0);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Which had been changed to this:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=GramE><code><span lang=EN-GB style='font-size:
10.0pt'>public</span></code></span><code><span lang=EN-GB style='font-size:
10.0pt'> static bool IsEmpty(this string value)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span><span class=GramE>return</span>
String.IsNullOrEmpty(value);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>For those non-C# readers there is a subtle
difference in behaviour that happens when the value is a null reference. In my
original implementation a NullReferenceException will be thrown, whereas in the
revised version it will be silently ignored. Looking back in the source code
repo I studied the associated changes and realised that this change was made to
fix a problem with null string references coming in through the web <st1:stockticker
w:st="on">API</st1:stockticker> framework in certain scenarios. I proposed that
the fix was in the wrong place as it changed the semantics of the extension
method [1]. After a brief discussion we refactored the code, added a couple of
unit tests to document the extension method behaviour and got on with our
lives. Sometimes it’s easy to forget how even a simple, 1-line method can hide
such detail.</span></p>

<h3><span lang=EN-GB>Unearthing Patterns</span></h3>

<p class=MsoNormal><span lang=EN-GB>Having the author around doesn’t always
help though. There are programmers you’ll meet which are not quite so amenable
to such discussions and will instead get easily offended if they suspect you’re
questioning their judgment.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>As you might deduce from the Robert Frost
quote at the very beginning I always approach any codebase with the assumption
that the author is a smarter programmer than me and knows more about the
problem domain too. At least, until I know for definite that isn’t the case. This
means when I see code that isn’t obviously simple [2] I err on the side of
caution and assume that I might be about to learn something new. This is almost
always true because even if I don’t learn something new about the language,
libraries or problem domain I will probably learn something about the author or
environment instead.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>One time I came across the following declaration
in a C++ codebase:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>std::vector&lt;std::string*&gt;
hostnames;<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>My instinct clearly told me this was wrong
as RAII almost always rules, but being new to the project and having the author
just feet away I politely quizzed them on it. The response was a very confrontational
“Are you reviewing my code?” After trying my best to explain my good intentions
I escaped with the knowledge I sought – the code was wrong. More importantly I
came away knowing a lot more about the author’s character.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Once you see some code where a programmer
has made what could be considered “a fundamental mistake”, you immediately begin
to question where else they may have made it. The version control system can
tell you what other commits someone’s made and with a sprinkling of
command-line magic it’s often possible to see where they’ve been and what
they’ve touched. In this instance I restricted myself to just the most critical
areas of the code but it paid dividends as I chalked up a couple more memory
leaks.</span></p>

<p class=MsoNormal style='tab-stops:313.1pt'><span lang=EN-GB><span
style='mso-tab-count:1'>                                                                                                        </span></span></p>

<p class=MsoNormal><span lang=EN-GB>Although somewhat jaded by this experience
I decided it was still my duty to point out to an ex-project member, who only worked
down the hall, that 19 of the memory leaks I’d just unearthed were due to him
forgetting to mark the base class destructor virtual even though they were
managed by a smart-pointer. Fortunately he was far more grateful for the
feedback.</span></p>

<h3><span lang=EN-GB>Blame</span></h3>

<p class=MsoNormal><span lang=EN-GB>One of the most useful tools in modern
source control systems is Blame. Whilst its name might suggest it be used for
nefarious purposes, such as starting a witch-hunt, it would be far better
thought of as “Excavate”. Starting with a revision it will show you who last
touched each line of code and what commit it came from. From there you can
trace back through the past changes looking at the evolution of the file. Sadly
the one thing it doesn’t show is where code has been deleted which can be a useful
lead some times.</span></p>

<h3><span lang=EN-GB>Revision Graph</span></h3>

<p class=MsoNormal><span lang=EN-GB>The other key tool in the VCS arsenal is
the revision graph. This tool shows you the birds-eye view of a file’s history
– what commits have taken place, their check-in comments, what branches changes
have been made on, how and when they were merged and what labels or tags have
been applied.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>If you have a bug and you want to know what
versions of your product the bug appears in this is almost certainly your
starting point.</span></p>

<h3><span lang=EN-GB>TICOSA</span></h3>

<p class=MsoNormal><span lang=EN-GB>I’ve mostly only been concerned with
small-scale software archaeology as it’s usually directly related to a change
I’ve needed to make. Occasionally I’ve done some larger scale spelunking, such
as rating contributors by their percentage of empty check-in comments, but
nothing much more than that.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>In January of this year I attended The
(First) International Conference on Software Archaeology [3] at the <st1:place
w:st="on"><st1:PlaceType w:st="on">Museum</st1:PlaceType> of <st1:PlaceName
 w:st="on">London</st1:PlaceName></st1:place>. There were a number of other
ACCU members present and we spent the day finding out a bit more about how
software archaeology might be used in other ways. Given its infancy the message
was fairly clear that whilst analysing the history of <span class=GramE>a
codebase</span> can be interesting, we’re still not sure exactly what the value
is. Nonetheless it was a useful day and hopefully in subsequent years we’ll get
to find out how it can be used more effectively.</span></p>

<h3><span lang=EN-GB>References</span></h3>

<p class=MsoNormal><span lang=EN-GB>[1] <a
href="http://chrisoldwood.blogspot.co.uk/2013/09/extension-methods-should-behave-like.html">http://chrisoldwood.blogspot.co.uk/2013/09/extension-methods-should-behave-like.html</a></span></p>

<p class=MsoNormal><span lang=EN-GB>[2] <a
href="http://en.wikipedia.org/wiki/Tony_Hoare#Quotations">http://en.wikipedia.org/wiki/Tony_Hoare#Quotations</a></span></p>

<p class=MsoNormal><span lang=EN-GB>[3] <a href="http://ticosa.org/">http://ticosa.org/</a></span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><st1:PersonName w:st="on"><span lang=EN-GB>Chris Oldwood</span></st1:PersonName></p>

<p class=MsoNormal><!--[if supportFields]><span lang=EN-GB><span
style='mso-element:field-begin'></span><span
style='mso-spacerun:yes'> </span>SAVEDATE<span style='mso-spacerun:yes'> 
</span>\@ &quot;dd MMMM yyyy&quot;<span style='mso-spacerun:yes'>  </span>\*
MERGEFORMAT <span style='mso-element:field-separator'></span></span><![endif]--><span
lang=EN-GB><span style='mso-no-proof:yes'>13 February 2014</span></span><!--[if supportFields]><span
lang=EN-GB><span style='mso-element:field-end'></span></span><![endif]--></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><u><span lang=EN-GB>Bio<o:p></o:p></span></u></p>

<p class=MsoNormal><span lang=EN-GB>Chris is a freelance developer who started
out as a bedroom coder in the 80’s writing assembler on 8-bit micros; these
days it’s C++ and C#. He also commentates on the Godmanchester duck race and
can be contacted via <a href="mailto:gort@cix.co.uk">gort@cix.co.uk</a> or
@chrisoldwood.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

</div>

</body>

</html>
