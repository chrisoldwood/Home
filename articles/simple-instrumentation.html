<html xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:st1="urn:schemas-microsoft-com:office:smarttags"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=windows-1252">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 11">
<meta name=Originator content="Microsoft Word 11">
<link rel=File-List href="simple-instrumentation_files/filelist.xml">
<title>Simple Instrumentation</title>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="stockticker"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="place"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="City"/>
<o:SmartTagType namespaceuri="urn:schemas-microsoft-com:office:smarttags"
 name="PersonName"/>
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>Chris Oldwood</o:Author>
  <o:LastAuthor>Chris Oldwood</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>5224</o:TotalTime>
  <o:Created>2013-07-25T06:51:00Z</o:Created>
  <o:LastSaved>2013-07-25T06:51:00Z</o:LastSaved>
  <o:Pages>1</o:Pages>
  <o:Words>3979</o:Words>
  <o:Characters>22685</o:Characters>
  <o:Company>Co Productions Ltd</o:Company>
  <o:Lines>189</o:Lines>
  <o:Paragraphs>53</o:Paragraphs>
  <o:CharactersWithSpaces>26611</o:CharactersWithSpaces>
  <o:Version>11.9999</o:Version>
 </o:DocumentProperties>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:Compatibility>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:UseWord2002TableStyleRules/>
  </w:Compatibility>
  <w:BrowserLevel>MicrosoftInternetExplorer4</w:BrowserLevel>
 </w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" LatentStyleCount="156">
 </w:LatentStyles>
</xml><![endif]--><!--[if !mso]><object
 classid="clsid:38481807-CA0E-42D2-BF39-B33AF135CC4D" id=ieooui></object>
<style>
st1\:*{behavior:url(#ieooui) }
</style>
<![endif]-->
<style>
<!--
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	font-family:"Times New Roman";
	mso-fareast-font-family:"Times New Roman";
	mso-ansi-language:EN-GB;}
h1
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:1;
	font-size:16.0pt;
	font-family:Arial;
	mso-font-kerning:16.0pt;
	mso-ansi-language:EN-GB;}
h3
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	page-break-after:avoid;
	mso-outline-level:3;
	font-size:13.0pt;
	font-family:Arial;
	mso-ansi-language:EN-GB;}
h5
	{mso-style-next:Normal;
	margin-top:12.0pt;
	margin-right:0cm;
	margin-bottom:3.0pt;
	margin-left:0cm;
	mso-pagination:widow-orphan;
	mso-outline-level:5;
	font-size:13.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:EN-GB;
	font-style:italic;}
a:link, span.MsoHyperlink
	{color:blue;
	text-decoration:underline;
	text-underline:single;}
a:visited, span.MsoHyperlinkFollowed
	{color:purple;
	text-decoration:underline;
	text-underline:single;}
code
	{font-family:"Courier New";
	mso-ascii-font-family:"Courier New";
	mso-fareast-font-family:"Times New Roman";
	mso-hansi-font-family:"Courier New";
	mso-bidi-font-family:"Courier New";}
@page Section1
	{size:612.0pt 792.0pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:35.4pt;
	mso-footer-margin:35.4pt;
	mso-paper-source:0;}
div.Section1
	{page:Section1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:"Table Normal";
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:10.0pt;
	font-family:"Times New Roman";
	mso-ansi-language:#0400;
	mso-fareast-language:#0400;
	mso-bidi-language:#0400;}
</style>
<![endif]-->
</head>

<body lang=EN-US link=blue vlink=purple style='tab-interval:36.0pt'>

<div class=Section1>

<h1 align=center style='text-align:center'><span lang=EN-GB>Simple Instrumentation</span></h1>

<h3><span lang=EN-GB>Introduction</span></h3>

<p class=MsoNormal><span lang=EN-GB>The days when an application was a simple
process that ran entirely locally are long gone. Most systems these days are complex
beasts that reach out to a variety of services which can be hosted both locally
and remotely. As the number of links in the chain grows, so does the potential
for a performance problem to surface. And as we delegate more and more work to
3<sup>rd</sup> party services instead of owning them, sometimes the best we can
hope for is to keep a very close eye on how they’re behaving.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The internal components we also rely on will
continually get upgraded with new features and bug fixes so we need to make
sure that any change in their performance characteristics are still within our
expected tolerances. Even during day-to-day operation there will be spikes in
volumes and anomalous behaviour in both our own code and those of our upstream
and downstream dependencies that will need to be investigated.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>If you’ve ever had a support query from a
user that just says “the system is running like a dog” and you have no
performance data captured from within the bowels of your application then you’ve
got an uphill battle. This article explores what it takes to add some basic
instrumentation to your code so that you can get a good idea of what is
happening in and around your system at any time.</span></p>

<h3><span lang=EN-GB>System-Scale Monitoring</span></h3>

<p class=MsoNormal><span lang=EN-GB>Your operations team will no doubt already
be monitoring the infrastructure, so why isn’t that enough? Well, for starters
they are almost certainly <i style='mso-bidi-font-style:normal'>only</i>
monitoring your production real estate – your development and test environments
are likely to be of little importance to them. And yet those are the
environments where you want to start seeing any performance impact from your
changes so that they can be dealt with swiftly before reaching production.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The second reason is that they only have a
1,000 foot view of the system. They can tell you about the peaks and troughs of
any server, but when an anomaly occurs they can’t tell you about which service
calls might have invoked that behaviour. Databases in particular have a habit
of behaving weirdly as the load spikes and so knowing which query is being
blocked can give you clues about what’s causing the spike.</span></p>

<h3><span lang=EN-GB>What to Measure</span></h3>

<p class=MsoNormal><span lang=EN-GB>Sir Tony Hoare tells us that “premature
optimisation is the root of all evil” [Hoare] and therefore the first rule of
thumb is to measure everything we can afford to. In a modern system where there
are umpteen network calls and file I/O there is very little for which the act
of measuring will in any way <i style='mso-bidi-font-style:normal'>significantly</i>
degrade the performance of the operation being measured.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Of course if you write an instrumentation
message to a log file for every disk I/O request you’ll probably spend more
time measuring than doing useful work and so the level of measurement needs to
be granular enough to capture something useful without being too intrusive or
verbose. This may itself depend on how and where you are capturing your data as
you probably don’t want to be contending with the resource that you’re trying
to measure.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>As a starting point I would expect to
measure every call out to a remote service, whether that is a web service,
database query, etc. Every remote call has so many other moving parts in play
that it’s almost certainly going to act up at some point. <st1:place w:st="on"><st1:City
 w:st="on">Reading</st1:City></st1:place> and writing files to disk, especially
when that disk is based remotely on a NAS/<st1:stockticker w:st="on">SAN</st1:stockticker>/<st1:stockticker
w:st="on">DFS</st1:stockticker> is also a must, although the granularity would
be to read/write the entire file. On top of those any intensive memory or CPU hogs
should also get instrumented as a matter of course.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>There is one scenario when I would consider
discarding the measurements for a task and that’s when an exception has been
thrown. If an error has occurred you cannot tell how much of the operation was
performed, which for a lost connection could be none, and so having lots of dubious
tiny points in your data will only succeed in distorting it.</span></p>

<h3><span lang=EN-GB>Types of Instrument</span></h3>

<p class=MsoNormal><span lang=EN-GB>You only need a few basic instruments to
help you capture most of the key metrics. Some of those instruments are “real”,
whereas others may need to be synthesized by using <st1:stockticker w:st="on">API</st1:stockticker>’s
from the OS or language runtime.</span></p>

<h5><span lang=EN-GB>Wall Clock</span></h5>

<p class=MsoNormal><span lang=EN-GB>By far the simplest instrument is the good
old fashioned clock. The term “wall clock” is often used to distinguish it from
other internal clocks as it measures elapsed time as perceived by the user (or
operator). These are probably the easiest to implement as virtually every
runtime has the ability to report the current date and time, and so therefore
you can calculate the difference.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The main thing you need to watch out for is
the difference between the precision and the accuracy of the clock. Although
you may be able to format the date and time down to 1 nanosecond that doesn’t
mean it’s captured at that resolution. For example the .Net System.DateTime
type has a precision measured in nanoseconds but is only accurate to around 16
ms [Lippert]. As things stand today I have found this good enough to capture
the vast majority of “big picture” measurements.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>There are often other platform specific alternatives
to the classic wall clock, some are old fashioned like the original GetTickCount()
<st1:stockticker w:st="on">API</st1:stockticker> in Windows which also only has
a resolution of 10-16 ms on the NT lineage (it was a whopping 50 ms under
3.x/95). The Windows QueryPerformanceCounter() <st1:stockticker w:st="on">API</st1:stockticker>
in contrast has a much, much higher resolution, due to the hardware used to
derive it, and it’s from this that the .Net StopWatch type gains its
sub-microsecond precision <i style='mso-bidi-font-style:normal'>and</i>
accuracy [Lippert]. However, be warned that this impressive feat is heavily
dependent on the hardware and is therefore more usable server-side than
client-side.</span></p>

<h5><span lang=EN-GB>Specialised Clocks</span></h5>

<p class=MsoNormal><span lang=EN-GB>Internally operating systems often track metrics
around process and thread scheduling. One such bit of data Windows provides is
the amount of time spent in the OS kernel as opposed to user space. Coupled
with the elapsed time you can discover some useful facts about your process.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>If it’s a high-performance computing (<st1:stockticker
w:st="on">HPC</st1:stockticker>) style engine that is expecting to be CPU
bound, you might expect all its time to be spent in user space, but if it’s in
neither you’re probably doing more I/O than you expect. I have observed a high
amount of time in the kernel when there are a large number of exceptions bouncing
around (and being ignored) or when the process is doing an excessive amount of
logging. The converse can also be true about an I/O bound task that seems to be
consuming too much CPU, such as during marshalling.</span></p>

<h5><span lang=EN-GB>Network Latency</span></h5>

<p class=MsoNormal><span lang=EN-GB>Prior to Windows 2000 the clocks on Windows
servers were notoriously bad, but with the addition of support for Kerberos the
situation got much better (it had to) as servers now synchronised their clocks
with a domain controller. With servers having a much better idea of what the
current time is, you can begin to capture the network latency incurred by a
request – this is the time it takes for the request to be sent and for the
response to the received.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>You can measure the latency by timing the
operation from the client’s perspective (the remote end, server-wise) and also
within the service handling the request (the local end, server-wise) and then calculating
the difference. For example, if the client sees the request taking 10 seconds
and the service knows it only spent 8 seconds processing it, the other 2
seconds must be spent in and around the infrastructure used to transport the
request and response. Although you might not be able to correctly apportion the
time to the request or response sides (as that relies on the absolute times)
you can at least calculate the total latency which only relies on the relative
differences.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>This kind of metric is particularly useful
anywhere you have a queue (or non-trivial buffering) in place as it will tell
you how long a message has been stuck in the pending state. For example in a
grid computing scenario there is usually a lot of infrastructure between your
client code and your service code (which is executed by a remote engine
process) that will queue your work and marshal any data to and from the client.
However, if the queue has the ability to retry operations you will have to
allow for the fact that the latency might also include numerous attempts. This
is one reason why handling failures and retries client-side can be beneficial.</span></p>

<h5><span lang=EN-GB>Memory Footprint</span></h5>

<p class=MsoNormal><span lang=EN-GB>Aside from the use, or idleness of your
CPUs you’ll also want to keep track of the memory consumed by your processes. Sadly
this is probably not tracked at a thread level like CPU times because a global
heap is in use. However, single-threaded processes are often used for simplicity
and resilience and so you might be in a position to track this accurately in
some parts of the system.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>On Windows you generally have to worry
about two factors – virtual address consumption and committed pages. Due to the
architecture of Windows’ heaps you can end up in the mysterious position of appearing
to have oodles of free memory and yet still receive an out-of-memory condition.
See my previous Overload article on breaking the 4 GB limit with 32-bit Windows
processes for more details [Memory]. Suffice to say that process recycling is a
common technique used with both managed <i style='mso-bidi-font-style:normal'>and
native</i> code to work around a variety of heap problems.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>For services with some form of caching
built-in memory footprint metrics will help you discover if your cache eviction
policy is working efficiently or not.</span></p>

<h5><span lang=EN-GB>Custom Measurements</span></h5>

<p class=MsoNormal><span lang=EN-GB>One of the problems with any measurement
taken in isolation is that you often need a little more knowledge about what
the “size” of the task actually was. If your workload varies greatly then
you’ll not know if 1 second is fast, acceptable or excessive unless you also
know that it had thousands of items to process. Then when you’re analysing your
data you can scale it appropriately to account for the workload.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>To help provide some context to the
instrument measurements it’s worth accumulating some custom measurements about
the task. These might include the number of items in the collection you’re
reading/writing or the number of bytes you’re sending/receiving.</span></p>

<h3><span lang=EN-GB>Causality</span></h3>

<p class=MsoNormal><span lang=EN-GB>Every similar set of measurements you
capture need to be related in some way to an operation and so you also need to
capture something about what that is and also, if possible, some additional
context about the <i style='mso-bidi-font-style:normal'>instance</i> of that
operation. Once you start slicing and dicing your data you’ll want to group
together the measurements for the same operation so that you can see how it’s
behaving over time.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Additionally when you start to detect
anomalies in your systems’ behaviour you’ll likely want to investigate them
further to see what lead to the scenario. Whilst the date and time the data was
captured is a good start, it helps if have some kind of “transaction
identifier” that you can use to correlate events across the whole system. I
described one such approach myself in a previous edition of Overload [Causality].</span></p>

<h3><span lang=EN-GB>Output Sinks</span></h3>

<p class=MsoNormal><span lang=EN-GB>Once you’ve started accumulating all this
data you’ll want to persist it so that you can chew over it later. There are
various options, none of which are mutually exclusive, and so it might make
sense to publish to multiple targets for different reasons – usually based
around active monitoring or passive offline investigation.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>One thing you’ll definitely want to bear in
mind is how you handle errors when writing to an output sink fails. You almost
certainly don’t want the failure to cause the underlying operation to also fail.
If the sink is remote you could try buffering the data for a short while, but then
you run the risk of destabilising the process, and eventually the machine [Memory],
if you buffer too much for too long.</span></p>

<h5><span lang=EN-GB>Log File</span></h5>

<p class=MsoNormal><span lang=EN-GB>The humble (text based) log file is still
with us, and for good reason. Many of us have honed our skills at manipulating
these kinds of files and as long as you keep the format simple, they can
provide a very effective medium.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The single biggest benefit I see in storing
your instrumentation data in your log files is the locality of reference – the
data about the operation’s performance is right there alongside the diagnostic
data about what it was doing. When it comes to support queries you’ve already
got lots of useful information in one place.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>One method to help with singling out the
data is to use a custom severity level, such as “PRF” (for performance), as
this will use one of the key fields to reduce the need for any complex pattern
matching in the initial filtering. The operation itself will need a unique
name, which could be derived from the calling method’s name, so that you can
aggregate values. And then you’ll need to the data encoded in a simple way,
such as key value pairs. Here is an example log message using that format:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>2013-06-26
17:54:05.345 PRF [Fetch Customers] Customer:Count=1000;WallClock:DurationInMs=123;<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Here we have the operation name – “Fetch Customers”
– and two measurements – the number of items returned followed by the elapsed
time in milliseconds. Although the simpler key names “Count” and “Duration” may
appear to suffice at first, it’s wise to qualify them with a namespace as you
may have more than one value captured with the same name. Including the units
also helps if you capture the same value in two different formats (e.g.
milliseconds and TimeSpan). This might seem redundant, but when reading a log
for support reasons it helps if you don’t have to keep doing arithmetic to work
out whether the values are significant or not.</span></p>

<h5><span lang=EN-GB>Classic Database</span></h5>

<p class=MsoNormal><span lang=EN-GB>Where better to store data than a database?
Your system may already capture some significant timings in your main database about
the work it’s doing, such as when a job was submitted, processed and completed.
And so you might also want your instrumentation data captured alongside it to
be in one place. Some people are more comfortable analysing data using SQL or
by pulling portions of data into a spreadsheet as not everyone is blessed with
elite command line skills and intricate knowledge of the Gnu toolset.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Of course when I say “classic” database I
don’t just mean your classic Enterprise-y RDBMS, the vast array of NOSQL
options available today are equally valid and quite possibly a better fit.</span></p>

<h5><span lang=EN-GB>Round Robin Database</span></h5>

<p class=MsoNormal><span lang=EN-GB>For analysis of long term trends the
previous two options probably provide the best storage, but when it comes to
the system’s dashboard you’ll only be interested in a much shorter time window,
the last 10 minutes for example. Here you’ll want something akin to a fixed-size
circular buffer where older data, which is of less interest, is either
overwritten or pruned to make room for newer values.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>There are a few variations on this idea;
one in particular is the Round Robin Database (or RRDtool [RRDtool]). This prunes
data by using a consolidation function to produce aggregate values that lower
the resolution of older data whilst still maintaining some useful data points.</span></p>

<h5><span lang=EN-GB>Performance Counters</span></h5>

<p class=MsoNormal><span lang=EN-GB>Another variation of the circular buffer
idea is to expose counters from the process itself. Here the process itself is
responsible for capturing and aggregating data on a variety of topics and
remote processes collect them directly instead. This has the advantage of not
requiring storage when you don’t need it as you then log only what you need via
a remote collector. However back at the beginning I suggested you probably want
to capture everything you can afford to, so this benefit seems marginal.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>One word of caution about the Windows
performance counter <st1:stockticker w:st="on">API</st1:stockticker> – it’s not
for the faint of heart. It is possible that it’s got better with recent
editions (or via a 3<sup>rd</sup> party framework) but there are some interesting
“issues” that lie in wait for the unwary. That said the concept still remains
valid, even if it’s implemented another way, such as using a message bus to
broadcast a status packet.</span></p>

<h3><span lang=EN-GB>A Simple Instrumentation Framework</span></h3>

<p class=MsoNormal><span lang=EN-GB>Anyway, enough about the theory what does
this look like in code. You shouldn’t be surprised to learn it’s not rocket
science. Basically you just want to start one or more instruments before a
piece of functionality is invoked, and stop them afterwards. Then write the
results to one or more sinks.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>If you’re working with C++ then RAII will
no doubt have already featured in your thoughts, and for C# developers the
Dispose pattern can give a similar low noise solution. The effect we want to
achieve looks something like this (I’m going to use C# for my examples):-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public Customers
FetchCustomers()<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>const string operation = “Fetch Customers”;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>var stopwatch = new Stopwatch();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>var cpuMonitor = new CpuMonitor();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>// Do the thing that fetches the customers.<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>cpuMonitor.Stop();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>stopwatch.Stop();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>var measurements = new Measurements<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>stopwatch.Measurements,<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>cpuMonitor.Measurements<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>};<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>sink.Write(operation, measurements);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>return customers;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>This code, which is largely boilerplate,
adds a lot of noise to the proceedings that obscures the business logic and so we
should be able to introduce some sort of façade to hide it. What I’d be looking
for is something a little more like this:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public Customers
FetchCustomers()<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>using (MeasureScope.With(Instruments.WallClock
| <o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>                             </span>Instruments.CpuMonitor))<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>// Do the thing that fetches the
customers.<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Hopefully this looks far less invasive.
Through the use of reflection in C# (or pre-processor macros in C++) we should
be able to determine a suitable name for the operation using the method name.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>By switching to flags for the instrument
types we’ve factored out some noise but made customising the instruments
harder. Luckily customisation is pretty rare and so it’s unlikely to be a
problem in practice. The façade could also provide some common helper methods
to simplify things further by wrapping up the common use cases, for example:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>using
(MeasureScope.WithWallClock())<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>or</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>using
(Measure.CpuBoundTask())<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The one other minor detail that I have so
far glossed over is how the output sink is determined. For cases where it needs
to be customised it can be passed in from above, but I’ve yet to ever need to
do that in practice. Consequently I tend to configure it in </span><code><span
lang=EN-GB style='font-size:10.0pt'>main()</span></code><span lang=EN-GB> and
store it globally, then reach out to get it from behind the façade.</span></p>

<h5><span lang=EN-GB>The Facade</span></h5>

<p class=MsoNormal><span lang=EN-GB>The façade used by the client code can be
implemented like this:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public static
class MeasureScope<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public static Controller With(Instruments
instruments)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>string operation = new StackFrame(1).GetMethod().Name;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>return With(operation, instruments);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public static Controller With(string
operation,<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>                                  </span>Instruments
instruments)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>return new Controller(operation,
instruments);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Retrieving the calling method name in C# (prior
to C# 4.0) relies on walking the stack back one frame. Of course if you write
any wrapper methods you’ll need to put the stack walking in there <i
style='mso-bidi-font-style:normal'>as well</i> or you’ll report the wrapper
method name instead of the business logic method name.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public
static class MeasureScope<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>. . .<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public static Controller WithWallClock()<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>string operation = new StackFrame(1).GetMethod().Name;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>return With(operation, Instruments.WallClock);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The same rule applies if you’ve used
closures to pass your invocation along to some internal mechanism that hides
grungy infrastructure code, such as your Big Outer Try Block [Errors].</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public Customers
FetchCustomers()<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>return Invoke(() =&gt;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>// Do the thing that fetches the
customers.<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>});<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public T
Invoke&lt;T&gt;(Func&lt;T&gt; operation)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>string operationName = new StackFrame(1).GetMethod().Name;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>using (MeasureScope.With(operationName, Instruments.WallClock))<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>return operation();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Bitwise flags seem to be a bit “old school”
these days, but for a short simple set like this they seem about right, plus
you have the ability to create aliases for common permutations:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>[Flags]<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public enum
Instruments<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>WallClock = 0x01,<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>CpuMonitor = 0x02,<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>MemoryMonitor = 0x04,<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>CpuBoundTaskMonitor = WallClock |
CpuMonitor,<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<h5><span lang=EN-GB>The Instrument Controller</span></h5>

<p class=MsoNormal><span lang=EN-GB>The behind-the-scenes controller class that
starts/stops the instruments and invokes the outputting is only a tiny bit more
complicated than the façade.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public class
Controller : IDisposable<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public static ISink DefaultSink { get; set;
}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public Controller(string operation,
Instruments instrumentFlags)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>var instruments = new List&lt;IInstrument&gt;();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>if ((instrumentFlags &amp;
Instruments.WallClock) != 0)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>           </span>instruments.Add(new WallClock());<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>. . .<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_operation = operation;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_instruments = instruments;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_sink = DefaultSink;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_instruments.ForEach((instrument) =&gt;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>            </span>instrument.Start();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>});<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public void Dispose()<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_instruments.ForEach((instrument) =&gt;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>            </span>instrument.Stop();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>});<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>var measurements = new
List&lt;KeyValuePair&lt;string, string&gt;&gt;();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>foreach (var instrument in
_instruments)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>           
</span>measurements.AddRange(instrument.Measurements);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_sink.Write(_operation, measurements);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>private readonly string _operation;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>private List&lt;IInstrument&gt;
_instruments;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>private ISink _sink;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<h5><span lang=EN-GB>The Sink</span></h5>

<p class=MsoNormal><span lang=EN-GB>The measurements that are returned from the
instruments are just string key/value pairs. Given their different nature –
datetime, timespan, scalar, etc. – it seems the most flexible storage format. I’ve
implemented the sink below as a simple wrapper that writes to a log file
through some unspecified logging framework.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public class
LogFileSink : ISink<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public void Write(string operation,<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>           </span>IEnumerable&lt;KeyValuePair&lt;string,
string&gt;&gt; measurements)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>var buffer = new StringBuilder();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>foreach (var measurement in
measurements)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>            </span>buffer.AppendFormat(&quot;{0}={1};&quot;,
measurement.Key, <o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>                                </span>measurement.Value);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>Log.Performance(“[{0}] {1}”, operation,
buffer);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Here I’ve assumed that the Log façade will
not allow an exception to propagate outside itself. That just leaves an out-of-memory
condition as the only other sort of failure that might be generated and I’d let
that propagate normally as it means the process will likely be unstable.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>The instruments are equally simple – a pair
of methods to control it and a property to retrieve the resulting metric(s).
Like all “good” authors I’ve chosen to elide some error handling in the Start()
and Stop() methods to keep the code simple, but suffice to say you probably
want to be considering what happens should they be called out of sequence.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public
interface IInstrument<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>void Start();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>void Stop();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>Measurements Measurements { get; }<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public class
WallClock : IInstrument<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public Measurements Measurements { get {
return _measurements; } }<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public void Start()<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_measurements.Clear();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_startTime = DateTime.Now;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>public void Stop()<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>var stopTime = DateTime.Now;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>var difference = stopTime - _startTime;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>        </span>_measurements.Add(new KeyValuePair&lt;string,
string&gt; <o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>       </span><span
style='mso-spacerun:yes'>               </span>(“WallClock:Duration”,
difference.ToString()));<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>private DateTime _startTime;<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>private Measurements _measurements = new Measurements();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Earlier I mentioned that I would avoid
writing measurements taken whilst an exception was being handled; that can be
achieved in C# with the following check [Exception]:-</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>public
static bool IsHandlingException()<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>return (Marshal.GetExceptionPointers() !=
IntPtr.Zero<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>         </span>|| Marshal.GetExceptionCode() != 0);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>. . .<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>if (!IsHandlingException())<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>{<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>var measurements = new
List&lt;KeyValuePair&lt;string, string&gt;&gt;();<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>foreach (var instrument in _instruments)<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>       
</span>measurements.AddRange(instrument.Measurements);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><o:p>&nbsp;</o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'><span
style='mso-spacerun:yes'>    </span>_sink.Write(_operation, measurements);<o:p></o:p></span></code></p>

<p class=MsoNormal><code><span lang=EN-GB style='font-size:10.0pt'>}<o:p></o:p></span></code></p>

<h3><span lang=EN-GB>Summary</span></h3>

<p class=MsoNormal><span lang=EN-GB>This article has shown that it’s relatively
simple to add some instrumentation calls within your own code to allow you to
track how it’s performing on a continual basis. It explained what sort of
measurements you might like to take to gain some useful insights into how your
service calls and computations are behaving. It then followed up by showing how
a simple framework can be written in C# that requires only out-of-the box
techniques and yet still remains fairly unobtrusive.</span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Once in place (I recommend doing this as
early as possible, as in right from the very start) you’ll be much better
prepared for <i style='mso-bidi-font-style:normal'>when</i> the inevitable
happens and the dashboard lights up like a Christmas tree and the phones start
buzzing.</span></p>

<h3><span lang=EN-GB>Acknowledgements</span></h3>

<p class=MsoNormal><span lang=EN-GB>Thanks to <st1:PersonName w:st="on">Tim
 Barrass</st1:PersonName> for introducing me to the round robin database as a
technique for persisting a sliding window of measurements and generally helping
me refine this idea. Additional thanks as always to the Overload advisors for
sparing my blushes by casting their critical eye and spotting my mistakes.</span></p>

<h3><span lang=EN-GB>References</span></h3>

<p class=MsoNormal><span lang=EN-GB>[Causality] Chris Oldwood, Causality –
relating distributed diagnostic contexts, Overload 114</span></p>

<p class=MsoNormal><span lang=EN-GB>[Errors] Andy Longshaw and Eoin Woods, The
Generation, Management and Handling of Errors (Part 2), Overload 93</span></p>

<p class=MsoNormal><span lang=EN-GB>[Exception] Ricci Gian Maria, detecting if
finally block is executing for an manhandled exception, <a
href="http://www.codewrecks.com/blog/index.php/2008/07/25/detecting-if-finally-block-is-executing-for-an-manhandled-exception">http://www.codewrecks.com/blog/index.php/2008/07/25/detecting-if-finally-block-is-executing-for-an-manhandled-exception</a></span></p>

<p class=MsoNormal><span lang=EN-GB>[Hoare] <a
href="http://en.wikipedia.org/wiki/Program_optimization">http://en.wikipedia.org/wiki/Program_optimization</a></span></p>

<p class=MsoNormal><span lang=EN-GB>[Lippert] Eric Lippert, Precision and
accuracy of DateTime, <a
href="http://blogs.msdn.com/b/ericlippert/archive/2010/04/08/precision-and-accuracy-of-datetime.aspx">http://blogs.msdn.com/b/ericlippert/archive/2010/04/08/precision-and-accuracy-of-datetime.aspx</a></span></p>

<p class=MsoNormal><span lang=EN-GB>[Memory] Chris Oldwood, Utilising more than
4GB of memory in 32-bit Windows process, Overload 113</span></p>

<p class=MsoNormal><span lang=EN-GB>[RRDtool] <a
href="http://oss.oetiker.ch/rrdtool">http://oss.oetiker.ch/rrdtool</a></span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span lang=EN-GB>Chris Oldwood</span></p>

<p class=MsoNormal><!--[if supportFields]><span lang=EN-GB><span
style='mso-element:field-begin'></span><span
style='mso-spacerun:yes'> </span>SAVEDATE<span style='mso-spacerun:yes'> 
</span>\@ &quot;dd MMMM yyyy&quot;<span style='mso-spacerun:yes'>  </span>\*
MERGEFORMAT <span style='mso-element:field-separator'></span></span><![endif]--><span
lang=EN-GB><span style='mso-no-proof:yes'>04 July 2013</span></span><!--[if supportFields]><span
lang=EN-GB><span style='mso-element:field-end'></span></span><![endif]--></p>

<p class=MsoNormal><span lang=EN-GB><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><u><span lang=EN-GB>Bio<o:p></o:p></span></u></p>

<p class=MsoNormal><span lang=EN-GB>Chris is a freelance developer who started
out as a bedroom coder in the 80’s writing assembler on 8-bit micros. These
days it’s C++ and C# on Windows in big plush corporate offices. He is also the
commentator for the Godmanchester Gala Day Duck Race and can be contacted via <a
href="mailto:gort@cix.co.uk">gort@cix.co.uk</a> or @chrisoldwood.</span></p>

</div>

</body>

</html>
